var app=angular.module("leverai-dev",[]);app.directive("ngTouchstart",function(){return function(e,t,o){t.bind("touchstart",function(t){e.$apply(function(){e.$eval(o.ngTouchstart,{$event:t})})})}}),app.directive("ngTouchmove",function(){return function(e,t,o){t.bind("touchmove",function(t){e.$apply(function(){e.$eval(o.ngTouchmove,{$event:t})})})}}),app.directive("compile",["$compile",function(a){return function(e,o,n){e.$watch(function(t){return t.$eval(n.compile)},function(t){o.html(t),a(o.contents())(e)})}}]),app.directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(t,e,o){var n=a(o.fileModel).assign;e.bind("change",function(){t.$apply(function(){n(t,e[0].files[0])})})}}}]),app.controller("ng-variables",["$scope",function(o){o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/")},o.init()}]),app.controller("ng-header",["$scope","$http","$document","$interval",function(r,n,t,e){r.notificationPanelOpen=!1,r.pollingInterval=null,r.pollingIntervalMs=3e4,r.hasMoreNotifications=!1,r.init=function(){console.log("Header with notifications detected!"),r.notificationPanelOpen=!1,r.getNotifications(null,5),r.startPolling(),t.on("click",function(t){var e=angular.element(document.querySelector(".notification-dropdown"));r.notificationPanelOpen&&0<e.length&&!e[0].contains(t.target)&&r.$apply(function(){r.notificationPanelOpen=!1})})},r.formatNotificationDate=function(t){return!t||(t=t.split(".")[0],t=new Date(t.replace(" ","T")),isNaN(t.getTime()))?"":t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})},r.getNotifications=function(i,t){var e=r.baseUrl+"api/get_notifications",o=[];i&&o.push("since="+encodeURIComponent(i)),t&&o.push("limit="+t),0<o.length&&(e+="?"+o.join("&")),n({method:"GET",url:e}).then(function(t){var e,o,t=t.data.notifications,n=!!i,a=!n;console.log("Notifications response - since:",i,"count:",t?t.length:0),Array.isArray(t)?(e=new Set,r.notifications&&r.notifications.forEach(function(t){e.add(t.id)}),o=[],t.forEach(function(t){n&&e.has(t.id)||(t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at)),o.push(t))}),n&&0<o.length?r.notifications=o.concat(r.notifications||[]):a&&(r.notifications=t.map(function(t){return t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at)),t})),r.notificationCount=r.notifications?r.notifications.filter(function(t){return"f"===t.is_read}).length:0,(a||n)&&r.checkForMoreNotifications()):a&&(r.notifications=[],r.notificationCount=0)}).catch(function(t){console.error("Error getting notifications:",t),i||(r.notificationCount=0)})},r.checkForMoreNotifications=function(){var t;r.notifications&&0!==r.notifications.length&&(t=r.notifications[r.notifications.length-1])&&t.created_at?(t=r.cleanDateForSince(t.created_at),t=r.baseUrl+"api/get_notifications?before="+encodeURIComponent(t)+"&limit=1",n({method:"GET",url:t}).then(function(t){t=t.data.notifications;r.hasMoreNotifications=Array.isArray(t)&&0<t.length}).catch(function(t){console.error("Error checking for more notifications:",t),r.hasMoreNotifications=!1})):r.hasMoreNotifications=!1},r.loadPreviousNotifications=function(t){t&&t.stopPropagation(),r.notifications&&0!==r.notifications.length&&(t=r.notifications[r.notifications.length-1])&&t.created_at?(t=r.cleanDateForSince(t.created_at),t=r.baseUrl+"api/get_notifications?before="+encodeURIComponent(t)+"&limit=5",n({method:"GET",url:t}).then(function(t){t=t.data.notifications;Array.isArray(t)&&0!==t.length?(t.forEach(function(t){t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at))}),r.notifications=r.notifications.concat(t),r.checkForMoreNotifications()):r.hasMoreNotifications=!1}).catch(function(t){console.error("Error loading previous notifications:",t),r.hasMoreNotifications=!1})):r.hasMoreNotifications=!1},r.cleanDateForSince=function(t){return t?t.split(".")[0]:null},r.startPolling=function(){r.stopPolling(),r.pollingInterval=e(function(){var t=null,e=r.notifications,o=e?e.length:0;0<o?(t=r.cleanDateForSince(e[0].created_at),console.log("Polling with since:",t,"Current notifications count:",o)):console.log("Polling without since (full refresh), current notifications count:",o),r.getNotifications(t)},r.pollingIntervalMs),console.log("Notification polling started (interval: "+r.pollingIntervalMs+"ms)")},r.stopPolling=function(){r.pollingInterval&&(e.cancel(r.pollingInterval),r.pollingInterval=null,console.log("Notification polling stopped"))},r.openModal=function(t){console.log("Open Modal called"),$("#"+t).removeClass("hidden"),$("#"+t).addClass("flex"),$("body").addClass("modal-open")},r.toggleNotificationPanel=function(t){r.getAllTickets(),t&&t.stopPropagation(),r.notificationPanelOpen=!r.notificationPanelOpen},r.markNotificationAsRead=function(t,e){e.stopPropagation(),n({method:"POST",url:r.baseUrl+"api/mark_as_read",data:{id:t}}).then(function(t){r.getNotifications(null,5)}).catch(function(t){console.error("Error marking notification as read:",t)})},r.markAllAsRead=function(t){t.stopPropagation(),n({method:"POST",url:r.baseUrl+"api/mark_all_as_read",data:{}}).then(function(t){r.getNotifications(null,5)}).catch(function(t){console.error("Error marking all notifications as read:",t)})},r.$on("$destroy",function(){r.stopPolling()}),r.init()}]),app.controller("ng-login",["$scope","$http",function(e,t){e.credentials={},e.login=function(){e.credentials.email&&e.credentials.password?($("html").addClass("loading"),t({method:"POST",url:e.baseUrl+"authenticate",data:e.credentials}).then(function(t){t.data.success?(toastr.success(t.data.message),window.location.href=e.baseUrl):(toastr.error(t.data.message),t.data.requires_payment&&(window.location.href=t.data.checkout_url),$("html").removeClass("loading"))}).catch(function(t){toastr.error(t.data),$("html").removeClass("loading")})):toastr.error("Please fill out all required fields.")},e.openModal=function(t){console.log("Open Modal called"),$("#"+t).removeClass("hidden"),$("#"+t).addClass("flex"),$("body").addClass("modal-open")}}]),app.controller("ng-subscribe",["$scope","$http",function(n,a){n.credentials={fullname:"",email:"",password:"",confirmPassword:"",subscriptionPlan:""},n.init=function(){console.log("Subscribe Controller Initialized")},n.plans={basic:{id:"price_12345",label:"1 hour per month - $50.00"},standard:{id:"price_67890",label:"10 hours per month - $400.00"},pro:{id:"price_98765",label:"100 hours per month - $3000.00"},daily:{id:"price_123456",label:"Daily - $50.00"}},n.proceedForPayment=function(){var t,e,o;$("html").addClass("loading"),n.credentials.fullname&&n.credentials.email&&n.credentials.password&&n.credentials.confirmPassword?n.credentials.password!==n.credentials.confirmPassword?(toastr.error("Passwords do not match."),$("html").removeClass("loading")):n.credentials.subscriptionPlan?(console.log("All validations passed, proceeding with API call"),t={name:n.credentials.fullname,email:n.credentials.email,password:n.credentials.password,plan:n.credentials.subscriptionPlan},e=window.location.hostname,o=window.location.pathname,e="localhost"===e||"127.0.0.1"===e||e.includes("localhost"),o=o.includes("/ci3_template/"),a.post(e||o?"/ci3_template/api/register_and_checkout":"/api/register_and_checkout",t).then(function(t){console.log("API Response:",t.data),t.data.url?($("html").removeClass("loading"),console.log("Redirecting to Stripe Checkout:",t.data.url),window.location.href=t.data.url):($("html").removeClass("loading"),toastr.error("Failed to create payment session."))},function(t){toastr.error(t.data.error||"Failed to create payment session."),$("html").removeClass("loading")})):(toastr.error("Please select a subscription plan."),$("html").removeClass("loading")):(toastr.error("Please fill out all required fields."),$("html").removeClass("loading"))},n.init()}]),app.controller("ng-dashboard-dev",["$scope","$http",function(o,t){o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/")},o.topUpTest=function(){console.log("Top Up Test called")},o.testLogin=function(){$("html").addClass("loading"),t({method:"POST",url:o.baseUrl+"test_login",data:o.credentials}).then(function(t){$("html").removeClass("loading"),"Login successful!"==t.data.message?(toastr.success("Login successful!"),o.remainingHours=t.data.remaining_hours):toastr.error(t.data.error)})},o.closeModal=function(t){$("#"+t).removeClass("flex"),$("#"+t).addClass("hidden"),$("body").removeClass("modal-open"),o.credentials={}},o.openModal=function(t){$("#"+t).removeClass("hidden"),$("#"+t).addClass("flex"),$("body").addClass("modal-open")},o.topUpHours=0,o.topUpPrice=50,o.topUpTotal=0,o.remainingHours=0,o.btnTopUpHours=function(t){"add"===t?o.topUpHours++:o.topUpHours--,o.topUpHours<0&&(o.topUpHours=0),o.topUpTotal=o.topUpHours*o.topUpPrice},o.btnTopUpProceed=function(){$("html").addClass("loading"),console.log("Proceed to Payment called"),t({method:"POST",url:o.baseUrl+"api/top_up",data:{hours:o.topUpHours,total:o.topUpTotal}}).then(function(t){console.log("API Response:",t.data),$("html").removeClass("loading"),t.data.success&&t.data.checkout_url?(o.remainingHours=parseInt(o.remainingHours)+parseInt(o.topUpHours),window.location.href=t.data.checkout_url):toastr.error(t.data.error||"Failed to process top-up.")},function(t){console.error("Full error object:",t),console.error("Error status:",t.status),console.error("Error data:",t.data),console.error("Error config:",t.config),$("html").removeClass("loading"),t.data&&t.data.error?toastr.error(t.data.error):toastr.error("An error occurred while processing your payment. Please try again.")})},o.testLogout=function(){t({method:"POST",url:o.baseUrl+"test_logout"}).then(function(t){toastr.success("Session cleared successfully")},function(t){toastr.error("Failed to clear session")})},o.init()}]),app.controller("ng-dashboard-customer",["$scope","$http",function(o,n){o.topUpHours=0,o.topUpTotal=0,o.remainingHours=0,o.topUpPrice=50,o.currentPage=1,o.itemsPerPage=5,o.searchText="",o.filteredData=[],o.loadingTickets=!0,o.ticketDetails={},o.ticketComments=[],o.commentData={text:""},o.sendingComment=!1,o.dedicate_hours_temp=0,o.tid_temp=null,o.$watch("searchText",function(t,e){t!==e&&(o.currentPage=1,o.applyFilter())}),o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/"),o.getAllTickets(),o.getRemainingHours()},o.closeModal=function(t){$("#"+t).removeClass("flex"),$("#"+t).addClass("hidden"),$("body").removeClass("modal-open"),o.topUpHours=0,o.topUpTotal=0,o.request={},o.tid_temp=null,o.dedicate_hours_temp=0,o.ticketDetails={},o.ticketComments=[]},o.openModal=function(t){$("#"+t).removeClass("hidden"),$("#"+t).addClass("flex"),console.log("Modal ID:",t),$("body").addClass("modal-open")},o.openRequestModal=function(e,t){$("html").addClass("loading"),o.tid_temp=t,n({method:"POST",url:o.baseUrl+"api/get_ticket_with_comments",data:{ticket_id:o.tid_temp}}).then(function(t){o.ticketDetails=t.data.ticket_details,o.ticketComments=t.data.ticket_comments,o.dedicate_hours_temp=Number(o.ticketDetails.dedicate_hours),o.commentData.text="",o.sendingComment=!1,$("#"+e).removeClass("hidden"),$("#"+e).addClass("flex"),$("body").addClass("modal-open"),setTimeout(function(){var t=document.querySelector(".comments-container");t&&(t.scrollTop=t.scrollHeight)},100)}).finally(function(){$("html").removeClass("loading")})},o.btnTopUpHours=function(t){"add"===t?o.topUpHours++:o.topUpHours--,o.topUpHours<0&&(o.topUpHours=0),o.topUpTotal=o.topUpHours*o.topUpPrice},o.btnTopUpProceed=function(){$("html").addClass("loading"),console.log("Proceed to Payment called"),n({method:"POST",url:o.baseUrl+"api/top_up",data:{hours:o.topUpHours,total:o.topUpTotal}}).then(function(t){console.log("API Response:",t.data),$("html").removeClass("loading"),t.data.success&&t.data.checkout_url?(o.remainingHours=parseInt(o.remainingHours)+parseInt(o.topUpHours),window.location.href=t.data.checkout_url):toastr.error(t.data.error||"Failed to process top-up.")},function(t){console.error("Full error object:",t),console.error("Error status:",t.status),console.error("Error data:",t.data),console.error("Error config:",t.config),$("html").removeClass("loading"),t.data&&t.data.error?toastr.error(t.data.error):toastr.error("An error occurred while processing your payment. Please try again.")})},o.getRemainingHours=function(){n({method:"GET",url:o.baseUrl+"api/remaining_hours"}).then(function(t){o.hours_remaining=t.data.hours_remaining,console.log("Hours remaining:",o.hours_remaining)},function(t){console.error("Error fetching remaining hours:",t)})},o.applyFilter=function(){o.searchText&&""!==o.searchText.trim()?o.filteredData=o.tickets.filter(function(t){return t.ticket_id&&t.ticket_id.toString().includes(o.searchText)||t.title&&t.title.toLowerCase().includes(o.searchText.toLowerCase())||t.dedicate_hours&&t.dedicate_hours.toString().includes(o.searchText)||t.status&&t.status.toLowerCase().includes(o.searchText.toLowerCase())}):o.filteredData=o.tickets},o.getAllTickets=function(){o.loadingTickets=!0,n({method:"GET",url:o.baseUrl+"api/get_all_tickets_by_user"}).then(function(t){o.tickets=t.data.tickets,o.applyFilter()}).finally(function(){o.loadingTickets=!1})},o.pageCount=function(){var t;return o.tickets&&(t=o.searchText&&""!==o.searchText.trim()?o.filteredData:o.tickets)?Math.ceil(t.length/o.itemsPerPage):0},o.setPage=function(t){o.currentPage=t},o.prevPage=function(){1<o.currentPage&&o.currentPage--},o.nextPage=function(){o.currentPage<o.pageCount()&&o.currentPage++},o.getPages=function(){var n=[],a=o.pageCount(),t=o.currentPage;if(a<=4)for(let t=1;t<=a;t++)n.push(t);else{let e,o;o=a-1<=t?(e=Math.max(1,a-2),a):t<=2?(e=1,3):(e=t-1,t+1);for(let t=e;t<=o;t++)n.push(t);o<a&&(n.push("..."),n.push(a))}return n},o.btnCreateRequest=function(){$("html").addClass("loading"),o.request&&o.request.title&&o.request.request_priority&&o.request.dedicate_hours&&o.request.details?o.hours_remaining<o.request.dedicate_hours||o.request.dedicate_hours<=0?(toastr.error("You do not have enough hours to dedicate. Need to top up more hours."),$("html").removeClass("loading")):n.post(o.baseUrl+"api/create_request",o.request).then(function(t){t.data.success?(o.closeModal("modal_create_request"),o.request={},o.loadingTickets=!0,Promise.all([n.get(o.baseUrl+"api/remaining_hours"),n.get(o.baseUrl+"api/get_all_tickets_by_user")]).then(function([t,e]){o.hours_remaining=t.data.hours_remaining,o.tickets=e.data.tickets,o.applyFilter(),o.loadingTickets=!1,o.$apply()}).finally(()=>{$("html").removeClass("loading"),toastr.success("Request created successfully")})):(toastr.error(t.data.error||"Failed to create request."),$("html").removeClass("loading"))}).catch(function(t){toastr.error("An error occurred while creating request. Please try again."),$("html").removeClass("loading")}):(toastr.error("Please fill out all required fields."),$("html").removeClass("loading"))},o.getAllComments=function(){n({method:"POST",url:o.baseUrl+"api/get_all_comments",data:{ticket_id:o.ticketDetails.tid}}).then(function(t){o.ticketComments=t.data.comments,setTimeout(function(){var t=document.querySelector(".comments-container");t&&(t.scrollTop=t.scrollHeight)},100)}).catch(function(t){o.ticketComments.push({error:!0,message:t.data.error})}).finally(function(){o.sendingComment=!1})},o.sendComment=function(t){console.log("Sending comment for ticket:",t),console.log("Comment:",o.commentData.text),o.commentData.text&&""!==o.commentData.text.trim()?o.sendingComment||(o.sendingComment=!0,n({method:"POST",url:o.baseUrl+"api/send_comment",data:{ticket_id:t.tid,message:o.commentData.text,title:t.title,user_id:t.uid}}).then(function(t){toastr.success(t.data.message),o.commentData.text=""}).catch(function(t){o.ticketComments.push({error:!0,message:t.data.error})}).finally(function(){o.getAllComments(),o.sendingComment=!1})):toastr.warning("Please enter a comment before sending.")},o.btnDedicateHours=function(t){console.log("Dedication hours temp:",o.dedicate_hours_temp),"add"===t?(o.hours_remaining--,o.hours_remaining<0?(o.hours_remaining=0,toastr.error("You do not have enough hours to dedicate. Need to top up more hours.")):o.ticketDetails.dedicate_hours++):o.ticketDetails.dedicate_hours<=o.dedicate_hours_temp?(o.ticketDetails.dedicate_hours=o.dedicate_hours_temp,toastr.error("You cannot subtract more hours than you have dedicated.")):(o.ticketDetails.dedicate_hours--,o.hours_remaining++)},o.btnUpdateDedicateHours=function(){$("html").addClass("loading"),n({method:"POST",url:o.baseUrl+"api/update_dedicate_hours",data:{ticket_id:o.tid_temp,dedicate_hours:o.ticketDetails.dedicate_hours,hours_remaining:o.hours_remaining}}).then(function(t){toastr.success(t.data.message)}).catch(function(t){toastr.error("Error updating status: "+t.data.error)}).finally(function(){$("html").removeClass("loading"),o.getAllTickets()})},o.init()}]),app.controller("ng-dashboard-admin",["$scope","$http","$compile",function(o,n,t){o.currentPage=1,o.itemsPerPage=5,o.searchText="",o.filteredData=[],o.loadingTickets=!0,o.sendingComment=!1,o.commentData={text:""},o.billingTotals=[],o.activePlanCounts=[],o.ticketCountsByStatus=[],o.$watch("searchText",function(t,e){t!==e&&(o.currentPage=1,o.applyFilter())}),o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/"),o.getBillingTotalsPrevCurr(),o.getActivePlanCounts(),o.getTicketCountsByStatus()},o.applyFilter=function(){o.searchText&&""!==o.searchText.trim()?o.filteredData=o.tickets.filter(function(t){return t.ticket_id&&t.ticket_id.toString().includes(o.searchText)||t.title&&t.title.toLowerCase().includes(o.searchText.toLowerCase())||t.dedicate_hours&&t.dedicate_hours.toString().includes(o.searchText)||t.status&&t.status.toLowerCase().includes(o.searchText.toLowerCase())}):o.filteredData=o.tickets},o.getAllRequests=function(){o.loadingTickets=!0,n({method:"GET",url:o.baseUrl+"api/get_all_tickets"}).then(function(t){o.tickets=t.data.tickets,o.applyFilter()}).finally(function(){o.loadingTickets=!1})},o.pageCount=function(){var t;return o.tickets&&(t=o.searchText&&""!==o.searchText.trim()?o.filteredData:o.tickets)?Math.ceil(t.length/o.itemsPerPage):0},o.setPage=function(t){o.currentPage=t},o.prevPage=function(){1<o.currentPage&&o.currentPage--},o.nextPage=function(){o.currentPage<o.pageCount()&&o.currentPage++},o.getPages=function(){var n=[],a=o.pageCount(),t=o.currentPage;if(a<=4)for(let t=1;t<=a;t++)n.push(t);else{let e,o;o=a-1<=t?(e=Math.max(1,a-2),a):t<=2?(e=1,3):(e=t-1,t+1);for(let t=e;t<=o;t++)n.push(t);o<a&&(n.push("..."),n.push(a))}return n},o.openModule=function(t){o.section="",$("html").addClass("loading"),n({method:"POST",url:o.baseUrl+"load_module",data:{module:t}}).then(function(t){$("html").removeClass("loading"),o.section=t.data.section},function(t){toastr.error("Error loading module: "+t.data.error),$("html").removeClass("loading")})},o.openModal=function(e,t){$("html").addClass("loading"),console.log("Opening Modal: "+e+" for ticket ID: "+t),o.tid_temp=t,n({method:"POST",url:o.baseUrl+"api/get_ticket_with_comments",data:{ticket_id:o.tid_temp}}).then(function(t){o.ticketDetails=t.data.ticket_details,o.ticketComments=t.data.ticket_comments,o.commentData.text="",o.sendingComment=!1,console.log(o.ticketDetails),console.log(o.ticketComments),$("#"+e).removeClass("hidden"),$("#"+e).addClass("flex"),$("body").addClass("modal-open"),setTimeout(function(){var t=document.querySelector(".comments-container");t&&(t.scrollTop=t.scrollHeight)},100)}).finally(function(){$("html").removeClass("loading")})},o.closeModal=function(t){$("#"+t).removeClass("flex"),$("#"+t).addClass("hidden"),$("body").removeClass("modal-open")},o.updateStatus=function(e){$("html").addClass("loading"),n({method:"POST",url:o.baseUrl+"api/update_status",data:{ticket_id:e.tid,status:e.status,dedicate_hours:e.dedicate_hours,user_id:e.uid}}).then(function(t){"Rejected"==e.status?(toastr.success("Ticket has been rejected and closed."),o.closeModal("modal_view_request"),o.getAllRequests()):toastr.success(t.data.message)}).catch(function(t){toastr.error("Error updating status: "+t.data.error)}).finally(function(){$("html").removeClass("loading"),o.getAllRequests()})},o.getAllComments=function(){n({method:"POST",url:o.baseUrl+"api/get_all_comments",data:{ticket_id:o.ticketDetails.tid}}).then(function(t){o.ticketComments=t.data.comments,setTimeout(function(){var t=document.querySelector(".comments-container");t&&(t.scrollTop=t.scrollHeight)},100)}).catch(function(t){o.ticketComments.push({error:!0,message:t.data.error})}).finally(function(){o.sendingComment=!1})},o.sendComment=function(t){o.commentData.text&&""!==o.commentData.text.trim()?o.sendingComment||(o.sendingComment=!0,n({method:"POST",url:o.baseUrl+"api/send_comment",data:{ticket_id:t.tid,message:o.commentData.text,title:t.title,user_id:t.uid}}).then(function(t){toastr.success(t.data.message),o.commentData.text=""}).catch(function(t){o.ticketComments.push({error:!0,message:t.data.error})}).finally(function(){o.getAllComments(),o.sendingComment=!1})):toastr.warning("Please enter a comment before sending.")},o.formatCurrency=function(t){return null==t||void 0===t||isNaN(t)?"0.00":parseFloat(t).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},o.getTotalRevenue=function(){var e=0;return o.billingTotals&&0<o.billingTotals.length&&o.billingTotals.forEach(function(t){t&&t.total_amount&&(e+=parseFloat(t.total_amount)||0)}),e},o.getBillingTotalsPrevCurr=function(){n({method:"GET",url:o.baseUrl+"api/get_billing_totals_prev_curr"}).then(function(t){o.billingTotals=t.data.billing_totals||[],console.log("Billing totals loaded:",o.billingTotals)}).catch(function(t){console.error("Error loading billing totals:",t),o.billingTotals=[]})},o.getPlanCount=function(e){var t;return o.activePlanCounts&&Array.isArray(o.activePlanCounts)&&(t=o.activePlanCounts.find(function(t){return t&&t.plan_name&&t.plan_name.toLowerCase()===e.toLowerCase()}))&&t.total_count?parseInt(t.total_count):0},o.getTotalActiveSubscriptions=function(){var e=0;return o.activePlanCounts&&Array.isArray(o.activePlanCounts)&&o.activePlanCounts.forEach(function(t){t&&t.total_count&&(e+=parseInt(t.total_count)||0)}),e},o.getActivePlanCounts=function(){n({method:"GET",url:o.baseUrl+"api/get_active_plan_counts"}).then(function(t){o.activePlanCounts=t.data.active_plan_counts||[],console.log("Active plan counts loaded:",o.activePlanCounts)}).catch(function(t){console.error("Error loading active plan counts:",t),o.activePlanCounts=[]})},o.getTicketCountByStatus=function(e){var t;return o.ticketCountsByStatus&&Array.isArray(o.ticketCountsByStatus)&&(t=o.ticketCountsByStatus.find(function(t){return t&&t.status&&t.status.toLowerCase()===e.toLowerCase()}))&&t.total_count?parseInt(t.total_count):0},o.getTotalTicketRequests=function(){var e=0;return o.ticketCountsByStatus&&Array.isArray(o.ticketCountsByStatus)&&o.ticketCountsByStatus.forEach(function(t){t&&t.total_count&&(e+=parseInt(t.total_count)||0)}),e},o.getTicketCountsByStatus=function(){n({method:"GET",url:o.baseUrl+"api/get_ticket_counts_by_status"}).then(function(t){o.ticketCountsByStatus=t.data.ticket_counts||[],console.log("Ticket counts by status loaded:",o.ticketCountsByStatus)}).catch(function(t){console.error("Error loading ticket counts by status:",t),o.ticketCountsByStatus=[]})},o.init()}]),app.controller("ng-header-admin",["$scope","$http","$document","$interval",function(r,n,t,e){r.notificationPanelOpen=!1,r.pollingInterval=null,r.pollingIntervalMs=3e4,r.hasMoreNotifications=!1,r.init=function(){console.log("Header with notifications detected!"),r.notificationPanelOpen=!1,r.getNotifications(null,5),r.startPolling(),t.on("click",function(t){var e=angular.element(document.querySelector(".notification-dropdown"));r.notificationPanelOpen&&0<e.length&&!e[0].contains(t.target)&&r.$apply(function(){r.notificationPanelOpen=!1})})},r.formatNotificationDate=function(t){return!t||(t=t.split(".")[0],t=new Date(t.replace(" ","T")),isNaN(t.getTime()))?"":t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})},r.getNotifications=function(i,t){var e=r.baseUrl+"api/get_notifications",o=[];i&&o.push("since="+encodeURIComponent(i)),t&&o.push("limit="+t),0<o.length&&(e+="?"+o.join("&")),n({method:"GET",url:e}).then(function(t){var e,o,t=t.data.notifications,n=!!i,a=!n;console.log("Notifications response - since:",i,"count:",t?t.length:0),Array.isArray(t)?(e=new Set,r.notifications&&r.notifications.forEach(function(t){e.add(t.id)}),o=[],t.forEach(function(t){n&&e.has(t.id)||(t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at)),o.push(t))}),n&&0<o.length?r.notifications=o.concat(r.notifications||[]):a&&(r.notifications=t.map(function(t){return t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at)),t})),r.notificationCount=r.notifications?r.notifications.filter(function(t){return"f"===t.is_read}).length:0,(a||n)&&r.checkForMoreNotifications()):a&&(r.notifications=[],r.notificationCount=0)}).catch(function(t){console.error("Error getting notifications:",t),i||(r.notificationCount=0)})},r.checkForMoreNotifications=function(){var t;r.notifications&&0!==r.notifications.length&&(t=r.notifications[r.notifications.length-1])&&t.created_at?(t=r.cleanDateForSince(t.created_at),t=r.baseUrl+"api/get_notifications?before="+encodeURIComponent(t)+"&limit=1",n({method:"GET",url:t}).then(function(t){t=t.data.notifications;r.hasMoreNotifications=Array.isArray(t)&&0<t.length}).catch(function(t){console.error("Error checking for more notifications:",t),r.hasMoreNotifications=!1})):r.hasMoreNotifications=!1},r.loadPreviousNotifications=function(t){t&&t.stopPropagation(),r.notifications&&0!==r.notifications.length&&(t=r.notifications[r.notifications.length-1])&&t.created_at?(t=r.cleanDateForSince(t.created_at),t=r.baseUrl+"api/get_notifications?before="+encodeURIComponent(t)+"&limit=5",n({method:"GET",url:t}).then(function(t){t=t.data.notifications;Array.isArray(t)&&0!==t.length?(t.forEach(function(t){t.created_at&&(t.formatted_date=r.formatNotificationDate(t.created_at))}),r.notifications=r.notifications.concat(t),r.checkForMoreNotifications()):r.hasMoreNotifications=!1}).catch(function(t){console.error("Error loading previous notifications:",t),r.hasMoreNotifications=!1})):r.hasMoreNotifications=!1},r.cleanDateForSince=function(t){return t?t.split(".")[0]:null},r.startPolling=function(){r.stopPolling(),r.pollingInterval=e(function(){var t=null,e=r.notifications,o=e?e.length:0;0<o?(t=r.cleanDateForSince(e[0].created_at),console.log("Polling with since:",t,"Current notifications count:",o)):console.log("Polling without since (full refresh), current notifications count:",o),r.getNotifications(t)},r.pollingIntervalMs),console.log("Notification polling started (interval: "+r.pollingIntervalMs+"ms)")},r.stopPolling=function(){r.pollingInterval&&(e.cancel(r.pollingInterval),r.pollingInterval=null,console.log("Notification polling stopped"))},r.toggleNotificationPanel=function(t){t&&t.stopPropagation(),r.notificationPanelOpen=!r.notificationPanelOpen},r.markNotificationAsRead=function(t,e){e.stopPropagation(),n({method:"POST",url:r.baseUrl+"api/mark_as_read",data:{id:t}}).then(function(t){r.getNotifications(null,5)}).catch(function(t){console.error("Error marking notification as read:",t)})},r.markAllAsRead=function(t){t.stopPropagation(),n({method:"POST",url:r.baseUrl+"api/mark_all_as_read",data:{}}).then(function(t){r.getNotifications(null,5)}).catch(function(t){console.error("Error marking all notifications as read:",t)})},r.handleNotificationClick=function(t,e){if(e&&e.stopPropagation(),r.markNotificationAsRead(t.id,e),"subscription"!==t.type&&t.ticket_id){for(var o=r.$parent;o&&!o.openModal;)o=o.$parent;o&&o.openModal?o.openModal("modal_view_request",t.ticket_id):window.angular&&window.angular.element(document.querySelector('[ng-controller="ng-dashboard-admin"]')).scope()&&(e=window.angular.element(document.querySelector('[ng-controller="ng-dashboard-admin"]')).scope())&&e.openModal&&e.openModal("modal_view_request",t.ticket_id)}else r.navigateToCustomers()},r.navigateToCustomers=function(){for(var t,e=r.$parent;e&&!e.openModule;)e=e.$parent;e&&e.openModule?e.openModule("customers"):window.angular&&window.angular.element(document.querySelector('[ng-controller="ng-dashboard-admin"]')).scope()&&(t=window.angular.element(document.querySelector('[ng-controller="ng-dashboard-admin"]')).scope())&&t.openModule&&t.openModule("customers")},r.$on("$destroy",function(){r.stopPolling()}),r.openUserProfileModal=function(t){$("#"+t).removeClass("hidden"),$("#"+t).addClass("flex"),console.log("Modal ID:",t),$("body").addClass("modal-open")},r.init()}]),app.controller("ng-customer",["$scope","$http",function(o,t){o.loadingCustomers=!0,o.customers=[],o.filteredData=[],o.searchText="",o.currentPage=1,o.itemsPerPage=5,o.$watch("searchText",function(t,e){t!==e&&(o.currentPage=1,o.applyFilter())}),o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/"),o.getAllCustomers()},o.applyFilter=function(){o.searchText&&""!==o.searchText.trim()?o.filteredData=o.customers.filter(function(t){return t.name&&t.name.toLowerCase().includes(o.searchText.toLowerCase())||t.email&&t.email.toLowerCase().includes(o.searchText.toLowerCase())||t.plan_name&&t.plan_name.toLowerCase().includes(o.searchText.toLowerCase())||t.hours_remaining&&t.hours_remaining.toString().includes(o.searchText)||t.status&&t.status.toLowerCase().includes(o.searchText.toLowerCase())}):o.filteredData=o.customers},o.getAllCustomers=function(){o.loadingCustomers=!0,t({method:"GET",url:o.baseUrl+"api/get_all_customers"}).then(function(t){o.customers=t.data.customers,o.applyFilter()}).finally(function(){o.loadingCustomers=!1})},o.customerPageCount=function(){var t;return o.customers&&(t=o.searchText&&""!==o.searchText.trim()?o.filteredData:o.customers)?Math.ceil(t.length/o.itemsPerPage):0},o.customerSetPage=function(t){o.currentPage=t},o.customerPrevPage=function(){1<o.currentPage&&o.currentPage--},o.customerNextPage=function(){o.currentPage<o.customerPageCount()&&o.currentPage++},o.customerGetPages=function(){var n=[],a=o.customerPageCount(),t=o.currentPage;if(a<=4)for(let t=1;t<=a;t++)n.push(t);else{let e,o;o=a-1<=t?(e=Math.max(1,a-2),a):t<=2?(e=1,3):(e=t-1,t+1);for(let t=e;t<=o;t++)n.push(t);o<a&&(n.push("..."),n.push(a))}return n}}]),app.controller("ng-billing",["$scope","$http",function(o,t){o.loadingBilling=!0,o.billing=[],o.filteredData=[],o.searchText="",o.currentPage=1,o.itemsPerPage=5,o.$watch("searchText",function(t,e){t!==e&&(o.currentPage=1,o.applyFilter())}),o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/"),o.getAllBilling()},o.applyFilter=function(){o.searchText&&""!==o.searchText.trim()?o.filteredData=o.billing.filter(function(t){return t.name&&t.name.toLowerCase().includes(o.searchText.toLowerCase())||t.email&&t.email.toLowerCase().includes(o.searchText.toLowerCase())||t.billing_type&&t.billing_type.toLowerCase().includes(o.searchText.toLowerCase())||t.amount&&t.amount.toString().includes(o.searchText)||t.status&&t.status.toLowerCase().includes(o.searchText.toLowerCase())}):o.filteredData=o.billing},o.getAllBilling=function(){o.loadingBilling=!0,t({method:"GET",url:o.baseUrl+"api/get_all_billing"}).then(function(t){o.billing=t.data.billing,o.applyFilter()}).finally(function(){o.loadingBilling=!1})},o.billingPageCount=function(){var t;return o.billing&&(t=o.searchText&&""!==o.searchText.trim()?o.filteredData:o.billing)?Math.ceil(t.length/o.itemsPerPage):0},o.billingSetPage=function(t){o.currentPage=t},o.billingPrevPage=function(){1<o.currentPage&&o.currentPage--},o.billingNextPage=function(){o.currentPage<o.billingPageCount()&&o.currentPage++},o.billingGetPages=function(){var n=[],a=o.billingPageCount(),t=o.currentPage;if(a<=4)for(let t=1;t<=a;t++)n.push(t);else{let e,o;o=a-1<=t?(e=Math.max(1,a-2),a):t<=2?(e=1,3):(e=t-1,t+1);for(let t=e;t<=o;t++)n.push(t);o<a&&(n.push("..."),n.push(a))}return n},o.downloadInvoicePDF=function(t){t?(t=o.baseUrl+"api/download_invoice_pdf?invoice_id="+encodeURIComponent(t),window.open(t,"_blank")):alert("Invoice ID is missing")}}]),app.controller("ng-user-profile",["$scope","$http",function(e,t){e.credentials={fullname:"",new_password:"",confirm_password:""},e.init=function(){t({method:"POST",url:e.baseUrl+"api/get_user_profile"}).then(function(t){e.credentials.fullname=t.data.user_profile.name}).catch(function(t){toastr.error(t.data)})},e.updateUserProfile=function(){e.credentials.fullname||e.credentials.new_password||e.credentials.confirm_password?e.credentials.new_password&&!e.credentials.confirm_password?toastr.error("Please confirm the new password."):e.credentials.new_password!==e.credentials.confirm_password?toastr.error("New password and confirm password do not match."):($("html").addClass("loading"),t({method:"POST",url:e.baseUrl+"api/update_user_profile",data:e.credentials}).then(function(t){t.data.success?(toastr.success("User profile updated successfully."),e.credentials={fullname:"",new_password:"",confirm_password:""},e.init(),e.closeModal("modal_user_profile")):toastr.error(t.data.error),$("html").removeClass("loading")}).catch(function(t){toastr.error(t.data),$("html").removeClass("loading")})):toastr.error("Please fill out all required fields.")}}]),app.controller("ng-test-variables",["$scope",function(o){o.init=function(){var t=window.location.hostname,e=window.location.pathname,t="localhost"===t||"127.0.0.1"===t||t.includes("localhost"),e=e.includes("/ci3_template/");o.baseUrl=window.location.protocol+"//"+window.location.host+(t||e?"/ci3_template/":"/")},o.init()}]);